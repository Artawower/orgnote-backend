name: CD for orgnote backend (dev)

on:
  workflow_run:
    workflows:
      - CI for orgnote backend
    types:
      - completed
    branches:
      - dev
  repository_dispatch:
    types: [trigger-deploy-dev]

jobs:
  deploy:
    name: Deploy Dev
    runs-on: ubuntu-latest
    if: >
      ${{ (github.event_name == 'repository_dispatch') ||
      (github.event.workflow_run.conclusion == 'success' && 
      github.event.workflow_run.head_branch == 'dev') }}
    environment: dev
    steps:
      - name: Deploy to dev
        uses: fifsky/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          user: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command: |
            # Ensure just is installed
            if ! command -v just &> /dev/null; then
              curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to ~/bin
              export PATH="$HOME/bin:$PATH"
            fi
            export PATH="$HOME/bin:$PATH"

            mkdir -p ~/orgnote/dev
            cd ~/orgnote/dev

            if [ ! -d "orgnote-backend" ]; then
              eval $(ssh-agent -s)
              ssh-add ~/.ssh/sb-back
              git clone git@github.com:Artawower/orgnote-backend.git
            fi

            cd orgnote-backend
            eval $(ssh-agent -s)
            ssh-add ~/.ssh/sb-back
            git fetch --all
            git checkout dev
            git reset --hard origin/dev

            cat <<EOT > .env.traefik
            ACME_EMAIL=${{ secrets.ACME_EMAIL }}
            EOT

            cat <<EOT > .env.dev
            DEBUG=true
            MONGO_USERNAME=${{ secrets.MONGO_USERNAME }}
            MONGO_PASSWORD=${{ secrets.MONGO_PASSWORD }}
            GITHUB_ID=${{ secrets.OAUTH_GITHUB_ID }}
            GITHUB_SECRET=${{ secrets.OAUTH_GITHUB_SECRET }}
            CLIENT_ADDRESS=${{ vars.CLIENT_ADDRESS }}
            BACKEND_URL=${{ vars.BACKEND_URL }}
            ACCESS_CHECK_URL=${{ vars.ACCESS_CHECK_URL }}
            ACCESS_CHECK_TOKEN=${{ secrets.ACCESS_CHECK_TOKEN }}
            S3_ACCESS_KEY=${{ secrets.S3_ACCESS_KEY }}
            S3_SECRET_KEY=${{ secrets.S3_SECRET_KEY }}
            S3_BUCKET=${{ vars.S3_BUCKET }}
            S3_USE_SSL=false
            MAXIMUM_FILE_SIZE=52428800
            EOT

            docker login --username=${{ secrets.DOCKERHUB_USERNAME }} --password=${{ secrets.DOCKERHUB_TOKEN }}
            docker pull orgnote/client:dev 2>/dev/null || true

            just deploy-dev
            just prune
          args: "-tt"
