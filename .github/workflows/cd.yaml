name: CD for orgnote backend (prod)

on:
  workflow_run:
    workflows:
      - CI for orgnote backend
    types:
      - completed
    branches:
      - master

jobs:
  deploy:
    name: Deploy Production
    runs-on: ubuntu-latest
    if: >
      ${{ github.event.workflow_run.conclusion == 'success' && 
      github.event.workflow_run.head_branch == 'master' }}
    environment: deploy
    steps:
      - name: Deploy to production
        uses: fifsky/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          user: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command: |
            mkdir -p ~/orgnote/prod
            cd ~/orgnote/prod

            if [ ! -d "orgnote-backend" ]; then
              eval $(ssh-agent -s)
              ssh-add ~/.ssh/sb-back
              git clone git@github.com:Artawower/orgnote-backend.git
            fi

            cd orgnote-backend
            eval $(ssh-agent -s)
            ssh-add ~/.ssh/sb-back
            git fetch --all
            git checkout master
            git reset --hard origin/master

            cat <<EOT > .env.traefik
            ACME_EMAIL=${{ secrets.ACME_EMAIL }}
            EOT

            cat <<EOT > .env.prod
            DEBUG=false
            MONGO_USERNAME=${{ secrets.MONGO_USERNAME }}
            MONGO_PASSWORD=${{ secrets.MONGO_PASSWORD }}
            GITHUB_ID=${{ secrets.OAUTH_GITHUB_ID }}
            GITHUB_SECRET=${{ secrets.OAUTH_GITHUB_SECRET }}
            CLIENT_ADDRESS=${{ vars.CLIENT_ADDRESS }}
            BACKEND_DOMAIN=${{ vars.BACKEND_DOMAIN }}
            BACKEND_SCHEMA=${{ vars.BACKEND_SCHEMA }}
            BACKEND_PORT=${{ vars.BACKEND_PORT }}
            ACCESS_CHECK_URL=${{ vars.ACCESS_CHECK_URL }}
            ACCESS_CHECK_TOKEN=${{ secrets.ACCESS_CHECK_TOKEN }}
            S3_ACCESS_KEY=${{ secrets.S3_ACCESS_KEY_PROD }}
            S3_SECRET_KEY=${{ secrets.S3_SECRET_KEY_PROD }}
            S3_BUCKET=${{ vars.S3_BUCKET_PROD }}
            S3_USE_SSL=false
            MAXIMUM_FILE_SIZE=52428800
            EOT

            docker login --username=${{ secrets.DOCKERHUB_USERNAME }} --password=${{ secrets.DOCKERHUB_TOKEN }}
            docker pull orgnote/client:latest

            # Traefik: start only if not running (shared between environments)
            if ! docker ps --format '{{.Names}}' | grep -q '^orgnote-traefik$'; then
              docker compose -f docker-compose.traefik.yaml --env-file .env.traefik up -d
            fi

            docker compose -f docker-compose.db.prod.yaml -f docker-compose.prod.yaml --env-file .env.prod up -d --build

            docker system prune -f
          args: "-tt"
